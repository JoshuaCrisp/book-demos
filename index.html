<html>
  <head>
    <title>Theater Disaster</title>
    <meta name="description" content="Panoramas and Cursors">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://rawgit.com/aframevr/aframe/801ab21/dist/aframe-master.min.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.js"></script>
    
    <link rel="stylesheet" type="text/css" href="resources/style.css">

  </head>

  <body>
    <div id="BlackDiv">
    <div id="menu" class="menu"></div>
    </div>
    <a-scene  light="defaultLightsEnabled: false" shadow="type: pcfsoft">  
      
      <!--The Theatre, people, video, and sky panorama-->
      <a-assets>
        <a-asset-item id="maria-gltf" src="assets/models/maria.gltf"></a-asset-item>
        <a-asset-item id="chair-obj" src="assets/models/chair.obj"></a-asset-item>
        <a-asset-item id="chairs-obj" src="assets/models/TheatreChairs.obj"></a-asset-item>
        <a-asset-item id="people-obj" src="assets/models/theatrePeople.obj"></a-asset-item>
        <a-asset-item id="proscenium-obj" src="assets/models/theatreProscenium.obj"></a-asset-item>
        <a-asset-item id="room-obj" src="assets/models/theatreRoom.obj"></a-asset-item>

        <video id="train-video" src="assets/train-video_Maria.mp4" playsinline>
          <track kind="subtitles" label="English subtitles" src="assets/trainTrack.vtt" srclang="en" default></track>
        </video>

        <img id="prosceniumMap" src="assets/textures/prosceniumDiffuseColor.jpg" />
        <img id="roomMap" src="assets/textures/theatreRoomDiffuseColor.png" />
        <img id="chairMap" src="assets/textures/chairDiffuseColor.png" />
        <img id="peopleMap" src="assets/textures/peopleDiffuseColor.png" />
        <img id="malmoPano" src="assets/malmo2.jpg">
      
        <a-asset-item id="objectWheels" src="assets/models/trainWheels.obj"></a-asset-item>
        <a-asset-item id="objectCab" src="assets/models/trainCab.obj"></a-asset-item>
        <a-asset-item id="objectBase" src="assets/models/trainBase.obj"></a-asset-item>
        <a-asset-item id="objectBoiler" src="assets/models/trainBoiler.obj"></a-asset-item>
        <a-asset-item id="objectStand" src="assets/models/trainStand.obj"></a-asset-item>

        <img id="wheelColor" src="assets/textures/WheelsCapTexture_baseColor.jpg" />
        <img id="wheelBmp" src="assets/textures/WheelsCapTexture_normal.png" />
        <img id="wheelAO" src="assets/textures/WheelsCapTexture_occ.jpg" />
        <img id="lightsColor" src="assets/textures/lightsHubsTexture_baseColor.jpg" />
        <img id="lightsBmp" src="assets/textures/lightsHubsTexture_normal.png" />
        <img id="lightsAO" src="assets/textures/lightsHubsTexture_occ.jpg" />
        <img id="boilerColor" src="assets/textures/boilerTexture_baseColor.jpg" />
        <img id="boilerBmp" src="assets/textures/boilerTexture_normal.png" />
        <img id="boilerAO" src="assets/textures/boilerTexture_occ.jpg" />
        <img id="reflectMap" src="assets/textures/reflectSphere.jpg" />
        <img id="standMap" src="assets/textures/trainStandDiffuseColor.png" />
      </a-assets>

      <a-sphere material="src:#malmoPano; side:back;" scale = "400 400 400" ></a-sphere>

      <a-entity id = "camera" position = "-2 -1.5 1.6 "rotation = "0 -29.2 0"><a-camera look-controls></a-camera></a-entity>

      <!-- Using the asset management system. -->
      <a-entity id="train" visible="true" shadow="cast: true, receive: true" rotation="4 -55 0" scale="1.5 1.5 1.5" position="43 0 -85">
        <a-entity obj-model="obj: #objectWheels" material="src:#wheelColor; normalMap:#wheelBmp; roughness: 0.5; metalness: 0.8; ambientOcclusionMap: #wheelAO; ambientOcclusionMapIntensity: 1.0; sphericalEnvMap: #reflectMap" shadow="cast: true, receive: true"></a-entity>
        <a-entity obj-model="obj: #objectCab" material="src:#wheelColor; normalMap:#wheelBmp; roughness: 0.5; metalness: 0.8; ambientOcclusionMap: #wheelAO; ambientOcclusionMapIntensity: 1.0; sphericalEnvMap: #reflectMap" shadow="cast: true, receive: true"></a-entity>
        <a-entity obj-model="obj: #objectBase" material="src:#lightsColor; normalMap:#lightsBmp; roughness: 0.5; metalness: 0.8; ambientOcclusionMap: #lightsAO; ambientOcclusionMapIntensity: 1.0; sphericalEnvMap: #reflectMap" shadow="cast: true, receive: true"></a-entity>
        <a-entity obj-model="obj: #objectBoiler" material="src:#boilerColor; normalMap:#boilerBmp; roughness: 0.5; metalness: 0.8; ambientOcclusionMap: #boilerAO; ambientOcclusionMapIntensity: 1.0; sphericalEnvMap: #reflectMap" shadow="cast: true, receive: true"></a-entity>
        <a-entity id ="trainStand" obj-model="obj: #objectStand" material="src:#standMap; transparent: true; opacity: 0;" visible = "false" shadow="cast: false, receive: true" position = "0 2 0"></a-entity>
      </a-entity>

      <!--The theater box itself goes invisible on the "theaterGone" signal --> 
      <a-entity id="theaterworld" position="0 0 0" referenceframe='parent: ar.user; userotation: false'>
        <a-entity id ="room" obj-model="obj: #room-obj" material="src:#roomMap; transparent: true; opacity: 1;" shadow="cast: false, receive: true" rotation="-90 -30 0" scale="1 1 1" position="7 -17 -5"></a-entity>
        <a-entity id ="proscenium" obj-model="obj: #proscenium-obj" material="src:#prosceniumMap; transparent: true; opacity: 1;" shadow="cast: true, receive: true" rotation="-90 -30 0" scale="1.040 1 1" position="6.810 -17 -5"></a-entity>          
        <a-entity id ="chairs" obj-model="obj: #chairs-obj" material="src:#chairMap; transparent: true; opacity: 1;" shadow="cast: true, receive: true" rotation="-90 -30 0" scale="1 1 1" position="7 -17 -5"></a-entity> 
        <a-entity id ="people" obj-model="obj: #people-obj" material="src:#peopleMap; transparent: true; opacity: 1;" shadow="cast: true, receive: true" rotation="-90 -30 0" scale="1 1 1" position="7 -17 -5"></a-entity>
        <a-gltf-model src="#maria-gltf" id ="maria" opacity="true" scale="160 160 160" position="-7.65 -13.7 -3.48" rotation="0 150 0"animation-mixer="clip: crossLegs;"></a-gltf-model>
        <a-video id ="video" src="#train-video" width="57.6" height="32.4" rotation="0 -30 0" position="35 7 -50" visible="false" opacity = "1"></a-video>
      </a-entity>
    
      
      <!--Lights  -->
      <a-entity light="shadowMapWidth:1024;
                      shadowMapHeight:1024;
                      shadowCameraNear:0.02;
                      decay:0.8;
                      distance:120;
                      intensity:1.5;
                      penumbra:0.36;
                      type:spot;
                      castShadow:true;
                      shadowCameraFov:100;
                      shadowCameraTop:50;
                      shadowCameraRight:40;
                      shadowCameraBottom:-40;
                      shadowCameraLeft:-40"
                      id=spotLight
                      position="45 8.08 -50.51"
                      data-aframe-default-light="true"
                      aframe-injected="false"
                      rotation="0 148.4 0">
                          
      </a-entity>
      <a-entity light="intensity:1;
                      color:#BBB;
                      type:ambient;"
                      id="houseLight"
                      position="0 0 0"
                      rotation="0 0 0"
                      scale="1 1 1"
                      visible="true"
                      data-aframe-default-light=""
                      aframe-injected="">
                        
      </a-entity> 
     
	  
    </a-scene>

<script>

  var menu = document.getElementById('menu');
      var button = document.createElement('button');
      button.textContent = "Begin" ;
      menu.appendChild(button);
      button.addEventListener('click', function (){videoElement.play();});
  var videoElement = document.querySelector("video");
  var textTracks = videoElement.textTracks; // one for each track element
  var textTrack = textTracks[0]; // corresponds to the first track element
  console.log("This is the text track: " + textTrack);
  var kind = textTrack.kind // e.g. "subtitles"
  var mode = textTrack.mode // e.g. "disabled", hidden" or "showing"
  
  
  textTrack.oncuechange = function (){

    var myobj = this.activeCues[0].text.replace(/\n/g, "").split("/");
            console.log(myobj)
            // Adding three to i by defualt so that we can pass through the sets
            for( var i = 0; i< myobj.length; i+=4){
              //The pattern will always be the same. selector/attribute/value/(optionally)duration/
                selector = document.getElementById(myobj[i]);
                console.log(selector);
                var attribute = myobj[i+1];
                console.log(attribute);
                var value = myobj[i+2];
                console.log(value);
                var duration = parseInt(myobj[i+3]);
                console.log(duration);
                //If i+3 is number, then it must be the duration
                if(duration != 0000){ 
                  var tween = document.createElement('a-animation');
                  tween.setAttribute('attribute', attribute);
                  tween.setAttribute('easing', 'linear');
                  tween.setAttribute('to',value);
                  tween.setAttribute('dur',duration);
                  selector.appendChild(tween);
                  //adding 1 to i to jump to the next set of information
                } 
                 //If i+3 is not a number, then it must be the beginning of a different selector set, meaning no duration
                else {selector.setAttribute(attribute,value)}
        
            }
    
  }
  
  
  
  
  
  
</script>

  </body>
</html>
